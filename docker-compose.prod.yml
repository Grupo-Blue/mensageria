version: "3.9"

services:
  frontend:
    image: "724698481758.dkr.ecr.${AWS_REGION:-us-east-2}.amazonaws.com/mensageria-front-prod:latest"
    environment:
      # URL interna do backend Docker (serviço abaixo)
      BACKEND_API_URL: https://api-mensageria.grupoblue.com.br
    networks:
      - mensageria-prod
      - proxy-services
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 10s

  backend:
    image: "724698481758.dkr.ecr.${AWS_REGION:-us-east-2}.amazonaws.com/mensageria-back-prod:latest"
    environment:
      # ============================================
      # CONFIGURAÇÕES BÁSICAS
      # ============================================
      NODE_ENV: production
      PORT: 3333
      LOCAL_PORT: 3333
      MENSAGERIA_HOST: https://api-mensageria.grupoblue.com.br
      SYSTEM_NAME: Mensageria

      # ============================================
      # AUTENTICAÇÃO
      # ============================================
      SECRET_KEY: your-secret-key-here-change-this-in-production
      X_AUTH_API: your-api-auth-key-here
      AUTH_TOKEN: your-auth-token-here

      # ============================================
      # API EXTERNA
      # ============================================
      API_URL: api-mensageria.grupoblue.com.br

      # ============================================
      # TELEGRAM
      # ============================================
      TELEGRAM_BOT_TOKEN: your-telegram-bot-token
      TELEGRAM_CALL_BACK_URL_TO_SEND_USER_ID: https://mensageria.grupoblue.com.br/api/telegram/callback

      # ============================================
      # WHATSAPP
      # ============================================
      IDENTIFICATION: mensageria
      WHATSAPP_GROUPS_CALLBACK_URL: https://mensageria.grupoblue.com.br/api/whatsapp/groups

      # ============================================
      # GOOGLE GEMINI AI
      # ============================================
      GOOGLE_API_KEY: your-google-gemini-api-key

      # ============================================
      # RESUMO DE GRUPOS WHATSAPP
      # ============================================
      RESUME_WHATSAPP_GROUP_ID: your-whatsapp-group-id-to-monitor
      RESUME_WHATSAPP_GROUP_ID_TO_SEND: your-whatsapp-group-id-to-send-resume
      RESUME_HOUR_OF_DAY: 22

      # ============================================
      # REDIS
      # ============================================
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      REDIS_NAME: test

      # ============================================
      # EMAIL (NODEMAILER)
      # ============================================
      MAIL_HOST: smtp.gmail.com
      MAIL_PORT: 587
      MAIL_USER: your-email@gmail.com
      MAIL_PASS: your-email-password

      # ============================================
      # GOOGLE SHEETS (Opcional)
      # ============================================
      GOOGLE_SHEETS_API_KEY: ""
      GOOGLE_SPREADSHEET_ID: ""

      # ============================================
      # Multi-tenant configuration
      # ============================================
      FRONTEND_API_URL: https://mensageria.grupoblue.com.br
      INTERNAL_SYNC_TOKEN: cd739c87f3f7a8a6a69407b639a6d7c6db3090e0d6bbe4cbd4176950a1d9ab27
    volumes:
      - mensageria-data-prod:/usr/src/app/data
      - mensageria-auth-info-baileys-prod:/usr/src/app/auth_info_baileys
      - mensageria-tmp-prod:/usr/src/app/tmp
    networks:
      - mensageria-prod
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure
      update_config:
        parallelism: 1
        delay: 10s

  migration:
    image: "724698481758.dkr.ecr.${AWS_REGION:-us-east-2}.amazonaws.com/mensageria-migration-prod:latest"
    networks:
      - mensageria-prod
    environment:
      # Mesmo banco descrito em DATABASE_SETUP.md, só que apontando para o host mysql do compose
      DATABASE_URL: mysql://root:fha78&^hKg@161.97.151.114:3306/mensageria
    deploy:
      replicas: 1
      restart_policy:
        condition: none

networks:
  mensageria-prod:
    driver: overlay
  proxy-services:
    external: true
volumes:
  mensageria-data-prod:
    driver: local
  mensageria-auth-info-baileys-prod:
    driver: local
  mensageria-tmp-prod:
    driver: local
