name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies (Frontend)
        run: |
          cd /home/runner/work/mensageria/mensageria
          pnpm install
        working-directory: .

      - name: Build Frontend
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            set -e  # Exit on error
            
            # Configurar caminho do projeto
            PROJECT_PATH="${{ secrets.DEPLOY_PATH || '/var/www/mensageria' }}"
            cd "$PROJECT_PATH" || exit 1
            
            echo "ğŸ“¦ Starting deployment..."
            echo "ğŸ“ Project path: $PROJECT_PATH"
            
            # Verificar se Ã© um repositÃ³rio git
            if [ ! -d ".git" ]; then
              echo "âš ï¸  Not a git repository. Skipping git operations."
            else
              # Salvar commit atual para rollback (opcional)
              CURRENT_COMMIT=$(git rev-parse HEAD) || true
              echo "ğŸ’¾ Current commit: $CURRENT_COMMIT"
              
              # Pull das mudanÃ§as mais recentes
              echo "â¬‡ï¸  Pulling latest changes from master..."
              git fetch origin
              git reset --hard origin/master
              git clean -fd
              
              NEW_COMMIT=$(git rev-parse HEAD)
              echo "âœ… Updated to commit: $NEW_COMMIT"
            fi
            
            # Verificar se pnpm estÃ¡ instalado
            if ! command -v pnpm &> /dev/null; then
              echo "âš ï¸  pnpm not found. Installing..."
              npm install -g pnpm
            fi
            
            # Instalar dependÃªncias do frontend
            echo "ğŸ“¥ Installing frontend dependencies..."
            pnpm install --frozen-lockfile --prod=false
            
            # Build do frontend
            echo "ğŸ”¨ Building frontend..."
            export NODE_ENV=production
            pnpm build
            
            # Verificar se build foi bem-sucedido
            if [ ! -d "dist" ]; then
              echo "âŒ Build failed: dist directory not found"
              exit 1
            fi
            
            echo "âœ… Build completed successfully"
            
            # Se existir backend separado, build tambÃ©m
            if [ -d "backend" ]; then
              echo "ğŸ”¨ Building backend..."
              cd backend
              if [ -f "package.json" ]; then
                npm install --production
                if [ -f "package.json" ] && grep -q '"build"' package.json; then
                  npm run build
                fi
              fi
              cd ..
            fi
            
            # Reiniciar serviÃ§os
            echo "ğŸ”„ Restarting services..."
            
            DEPLOYED=false
            
            # Tentar PM2
            if command -v pm2 &> /dev/null; then
              echo "ğŸ”„ Using PM2..."
              if pm2 list | grep -q "mensageria"; then
                pm2 restart mensageria
              else
                pm2 start dist/index.js --name mensageria
              fi
              pm2 save
              DEPLOYED=true
            fi
            
            # Tentar Docker Compose
            if [ "$DEPLOYED" = false ] && [ -f "docker-compose.yml" ]; then
              echo "ğŸ”„ Using Docker Compose..."
              docker-compose down
              docker-compose up -d --build
              DEPLOYED=true
            fi
            
            # Tentar systemd
            if [ "$DEPLOYED" = false ] && systemctl list-unit-files | grep -q "mensageria.service"; then
              echo "ğŸ”„ Using systemd..."
              sudo systemctl restart mensageria.service
              DEPLOYED=true
            fi
            
            if [ "$DEPLOYED" = false ]; then
              echo "âš ï¸  No deployment method found. Please restart the service manually."
              echo "ğŸ’¡ Available methods: PM2, Docker Compose, or systemd"
            else
              echo "âœ… Service restarted successfully"
            fi
            
            echo "ğŸ‰ Deployment completed successfully!"

      - name: Notify Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment successful!"
          else
            echo "âŒ Deployment failed!"
          fi

